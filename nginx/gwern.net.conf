map_hash_bucket_size 128; # https://nginx.org/en/docs/http/ngx_http_map_module.html
map $request_uri $new_uri {
    ## library of custom redirects:
    ### first, manual moves, updates, mistake fixes:
    include /home/gwern/gwern.net/static/redirects/nginx.conf;
    ### then hide garbage from logs:
    include /home/gwern/gwern.net/static/redirects/nginx-broken.conf;
}

## Rewrite https://gwern.net → https://www.gwern.net
server{
    #redirect non-www to www
    listen 80;
    listen 443 ssl;
        server_name gwern.net;

        ssl_certificate /home/gwern/ssl/cloudflare.cert;
        ssl_certificate_key /home/gwern/ssl/cloudflare.key;
        return 301 https://www.$host$request_uri;
}

server {
     listen 80  default_server;
     listen 443 default_server ssl;

     server_name www.gwern.net;

     ssl_certificate      /home/gwern/ssl/cloudflare.cert;
     ssl_certificate_key  /home/gwern/ssl/cloudflare.key;

     root /home/gwern/gwern.net;
     index index;

     error_page 404 /static/404;

     default_type text/html;

     location / {

        # for linkArchive.sh/LinkArchive.hs: ensure that no crawlers pick up my mirrors, to reduce DMCA risk.
        location /docs/www/               { add_header X-Robots-Tag "none, nosnippet, noarchive, nocache"; }
        # repeat robots.txt's major rules, because Google Search appears to ignore it:
        location /metadata/               { add_header X-Robots-Tag "none, nosnippet, noarchive, nocache"; }

        ## support basic MIME types
        include  /etc/nginx/mime.types;
        ## support non-basic MIME types...
        types {
          text/markdown page;
          application/x-maff maff;
          text/plain conf;
          text/csv csv;
          text/x-adobe-acrobat-drm ebt;
          application/epub+zip epub;
          text/x-haskell hs;
          htm text/html;
          application/msaccess mdb;
          message/rfc822 mht;
          application/vnd.oasis.opendocument.text odt;
          application/vnd.oasis.opendocument.spreadsheet ods;
          application/vnd.oasis.opendocument.presentation odp;
          text/x-opml opml;
          text/x-patch patch;
          text/x-diff  diff;
          text/x-php php;
          text/x-python py;
          text/x-r R;
          text/x-c c;
          application/vnd.rn-realmedia rm;
          text/plain sh;
          text/plain bash;
          application/wasm wasm;
          application/x-tar tar;
          application/font-sfnt ttf;
          image/x-xcf xcf;
          application/x-xz xz;
          text/yaml yaml;
          audio/wav wav;
          video/mp4 mkv; }

        # force text files into UTF-8 to avoid 'mojibake':
        charset utf-8;
        source_charset utf-8;
        charset_types htm text/css text/csv text/markdown text/plain text/x-diff text/x-haskell text/x-opml text/x-patch text/x-php text/x-r text/x-shellscript text/yaml;

        ## somewhat aggressive caching:
        add_header Cache-Control "max-age=77760000, public, immutable";

        # prefetch gwern.net site logo:
        add_header Link "</static/img/logo/logo-smooth.svg#logo>; rel=preload; as=image; fetchpriority=high";
        # add_header Link "</static/css/fonts.css?v=1655420134>; rel=preload; as=style; fetchpriority=high";
        # add_header Link "</static/css/default.css?v=1669354834>; rel=preload; as=style; fetchpriority=high";

        ## allow directory browsing, particularly useful for /docs/*
        autoindex on;

        # server-side includes <https://en.wikipedia.org/wiki/Server_Side_Includes>:
        ## used in templating for the includes to avoid the need for full site rebuilds. Can just rsync up & expire cache.
        ssi on; # http://nginx.org/en/docs/http/ngx_http_ssi_module.html
        ssi_last_modified on; # we are just doing simple transclusion, no dynamic funny business, so last-modified doesn't change

        # begin redirect rewrites: for cases where a more powerful regexp match-and-replace is required

        rewrite ^/static/css/fonts\.css(?<version>\?v=[0-9]+)$ /static/css/fonts-VERSIONED.css$version permanent;

        ## replace all spaces with hyphens:
        rewrite ^(.*)(\s|%20)(.*)$ $1-$3 permanent;
        ## fix a bunch of very obxious crawlers:
        rewrite ^/(?<original>.*)\?revision\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\?chat$ /$original permanent;
        rewrite ^/(?<original>.*)\?feedback.*$ /$original permanent;
        rewrite ^/100-y/ALL/score/1/(?<original>.*) /$original permanent;
        rewrite ^/2017/11/20/(?<original>.*) /$original permanent;
        rewrite ^/BINARY/(?<original>.*) /$original permanent;
        rewrite ^/Prediction-markets/(?<original>.*) /$original permanent;
        rewrite ^/Red/feed/(?<original>.*) /$original permanent;
        rewrite ^/Yoga.*/(?<original>.*) /$original permanent;
        rewrite ^/[a-z]/(?<original>.*) /$original permanent;
        rewrite ^/about/(?<original>.*) /$original permanent;
        rewrite ^/advanced-search/(?<original>.*) /$original permanent;
        rewrite ^/all-essays/(?<original>.*) /$original permanent;
        rewrite ^/alternates/s615b/(?<original>.*) /$original permanent;
        rewrite ^/amp/(?<original>.*) /$original permanent;
        rewrite ^/b/(?<original>.*) /$original permanent;
        rewrite ^/blog/chasing-10x-leveraging-a-poor-memory-in-software-engineering/(?<original>.*) /$original permanent;
        rewrite ^/blog/everything-i-know-strategies-tips-and-tricks-for-spaced-repetition-anki/(?<original>.*) /$original permanent;
        rewrite ^/border-wall/(?<original>.*) /$original permanent;
        rewrite ^/card/(?<original>.*) /$original permanent;
        rewrite ^/cart/(?<original>.*) /$original permanent;
        rewrite ^/choice/(?<original>.*) /$original permanent;
        rewrite ^/component/(?<original>.*) /$original permanent;
        rewrite ^/configure/(?<original>.*) /$original permanent;
        rewrite ^/contests/(?<original>.*) /$original permanent;
        rewrite ^/docs/2010-crc/(?<original>.*) /$original permanent;
        rewrite ^/docs/2020-crc/(?<original>.*) /$original permanent;
        rewrite ^/docs/docs/(?<original>.*) /$original permanent;
        rewrite ^/docs/images/(?<original>.*) /docs/$original permanent;
        rewrite ^/images/images/(?<original>.*) /images/$original permanent;
        rewrite ^/docs/iq/docs/(?<original>.*) /docs/$original permanent;
        rewrite ^/docs/tags/(?<original>.*) /tags/$original permanent;
        rewrite ^/docs/www/au.news.yahoo.com/Chrome/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/au.news.yahoo.com/Safari/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/brnensky.denik.cz/edge/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/\+/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/\_/js/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/play\.google\.com/\_/ss/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.adressa.no/Trident/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.belfastlive.co.uk/offline/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.dailymail.co.uk\/android-app\:\/\/com.dailymail.online/dailymail/article/2825778/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.sueddeutsche.de/edge/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.upi.com/YWRzLmxmc3RtZWRpYS5jb20vZ2V0YWQ/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/yuki-onna.livejournal.com/flymeango.com/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/yuki-onna.livejournal.com/www.arte.tv/en/(?<original>.*) /$original permanent;
        rewrite ^/docs/www\/free\.law/OPR/(?<original>.*) /$original permanent;
        rewrite ^/event/(?<original>.*) /$original permanent;
        rewrite ^/feature/(?<original>.*) /$original permanent;
        rewrite ^/find_v2/(?<original>.*) /$original permanent;
        rewrite ^/fonts/(?<original>.*) /$original permanent;
        rewrite ^/foo/(?<original>.*) /$original permanent;
        rewrite ^/forum/(?<original>.*) /$original permanent;
        rewrite ^/help/(?<original>.*) /$original permanent;
        rewrite ^/homepage-test/(?<original>.*) /$original permanent;
        rewrite ^/in-depth/(?<original>.*) /$original permanent;
        rewrite ^/initiatives/(?<original>.*) /$original permanent;
        rewrite ^/live-blog/(?<original>.*) /$original permanent;
        rewrite ^/login/(?<original>.*) /$original permanent;
        rewrite ^/m/(?<original>.*) /$original permanent;
        rewrite ^/my-account/(?<original>.*) /$original permanent;
        rewrite ^/opinion/(?<original>.*) /$original permanent;
        rewrite ^/p/(?<original>.*) /$original permanent;
        rewrite ^/partner_content/(?<original>.*) /$original permanent;
        rewrite ^/performer/(?<original>.*) /$original permanent;
        rewrite ^/poisoned-cities/(?<original>.*) /$original permanent;
        rewrite ^/privacy/(?<original>.*) /$original permanent;
        rewrite ^/products/(?<original>.*) /$original permanent;
        rewrite ^/satellites/bible/(?<original>.*) /$original permanent;
        rewrite ^/source/I0.*/(?<original>.*) /$original permanent;
        rewrite ^/source/LP.*/(?<original>.*) /$original permanent;
        rewrite ^/soylent/library/death/suicide/famous/(?<original>.*) /$original permanent;
        rewrite ^/soylent/library/travel/cities/nyc/(?<original>.*) /$original permanent;
        rewrite ^/sponsored/(?<original>.*) /$original permanent;
        rewrite ^/sponsored_sections/(?<original>.*) /$original permanent;
        rewrite ^/static/docs/(?<original>.*) /docs/$original permanent;
        rewrite ^/store/configure/xbox-design-lab/(?<original>.*) /$original permanent;
        rewrite ^/stylesheets/(?<original>.*) /$original permanent;
        rewrite ^/terms/(?<original>.*) /$original permanent;
        rewrite ^/trust/(?<original>.*) /$original permanent;
        rewrite ^/videos/(?<original>.*) /$original permanent;
        rewrite ^/wp-content/(?<original>.*) /$original permanent;
        rewrite ^/locales/(?<original>.*) /$original permanent;
        rewrite ^/merchants/(?<original>.*) /$original permanent;
        rewrite ^/strong-opinions-weakly-held/(?<original>.*) /$original permanent;
        rewrite ^/uris/(?<original>.*) /$original permanent;
        rewrite ^/_uris/(?<original>.*) /$original permanent;
        rewrite ^/instances/(?<original>.*) /$original permanent;
        rewrite ^/_pages/(?<original>.*) /$original permanent;
        rewrite ^/partner/(?<original>.*) /$original permanent;
        rewrite ^/services/(?<original>.*) /$original permanent;
        rewrite ^/v/(?<original>.*) /$original permanent;
        rewrite ^/v2/(?<original>.*) /$original permanent;
        rewrite ^/articles/(?<original>.*) /$original permanent;
        rewrite ^//(?<original>.*) /$original permanent;
        rewrite ^/docs/sr/\^/live/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/old.reddit.com/\^/live/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/Edg/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/_/js/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/_/ss/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/type.googleapis.com/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/market.android.com/\+/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.google.com/\+/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.google.com/Edg/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.lenovo.com/Yoga.*/p/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.supermemo.com/Trident/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.thedenverchannel.com/Trident/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.baltimoresun.com/Trident/(?<original>.*) /$original permanent;
        rewrite ^/articleComments/(?<original>.*) /$original permanent;
        rewrite ^/43010785/wallanews/innerpages/(?<original>.*) /$original permanent;
        rewrite ^/bucket/3067d498bc60d7bdfa033571e782efbcf5b28c5c/(?<original>.*) /$original permanent;
        rewrite ^/connecticut/norwalk/police-fire/norwalk-police-bust-major-marijuana-operation-after-finding-pot-in-mail/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/au.news.yahoo.com/Chromium/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/drugs.globalincidentmap.com/(?<original>.*) /$original permanent;
        rewrite ^/weather/(?<original>.*) /$original permanent;
        rewrite ^/connecticut/norwalk/(?<original>.*) /$original permanent;
        rewrite ^/2017/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/groups.google.ca/+/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/groups.google.*/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/CriOS/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/Edge/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/Firefox/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/IEMobile/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/Silk/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/Chrome/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/Version/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/blogs.msdn.microsoft.com/WebKit/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/bgr.com/Version/(?<original>.*) /$original permanent;
        rewrite ^/community-static/8891523-register/(?<original>.*) /$original permanent;
        rewrite ^/community-static/4805458-metroland-media-group-commenting-guidelines/(?<original>.*) /$original permanent;
        rewrite ^/community-static/2545471-mississauga-about-us/(?<original>.*) /$original permanent;
        rewrite ^/2015/04/21/sane-finds-100-hits-of-lsd-during-petoskey-search/(?<original>.*) /$original permanent;
        rewrite ^/article/dn8317-meditation-builds-up-the-brain/(?<original>.*) /$original permanent;
        rewrite ^/app.php/mentionloc/(?<original>.*) /$original permanent;
        rewrite ^/ark:/67531/metadc.*/(?<original>.*) /$original permanent;
        rewrite ^/article/dn14249-interview-its-a-dogs-life-again/(?<original>.*) /$original permanent;
        rewrite ^/datapreview/(?<original>.*) /$original permanent;
        rewrite ^/display/heraldsun.com.au/(?<original>.*) /$original permanent;
        rewrite ^/quot./(?<original>.*) /$original permanent;
        rewrite ^/quot.(?<original>.*) $original permanent;
        rewrite ^/wcsstore/PetcoStore/(?<original>.*) /$original permanent;
        rewrite ^/transcript/(?<original>.*) /$original permanent;
        rewrite ^/static-assets/(?<original>.*) /$original permanent;
        rewrite ^/source/.*/(?<original>.*) /$original permanent;
        rewrite ^/region/(?<original>.*) /$original permanent;
        rewrite ^/profile/papers/(?<original>.*) /$original permanent;
        rewrite ^/profile/collections/(?<original>.*) /$original permanent;
        rewrite ^/profile/(?<original>.*) /$original permanent;
        rewrite ^/money/(?<original>.*) /$original permanent;
        rewrite ^/reviews/soy-isoflavones_red-clover_black-cohosh_supplements/phytoestrogens/(?<original>.*) /$original permanent;
        rewrite ^/reviews/turmeric-curcumin-supplements-spice-review/turmeric/(?<original>.*) /$original permanent;
        rewrite ^/reviews/Vitamin_A_Retinol_Beta-Carotene_Cod_Liver_Oil/Vitamin_A/(?<original>.*) /$original permanent;
        rewrite ^/journal/revw.*/(?<original>.*) /$original permanent;
        rewrite ^/jfe/(?<original>.*) /$original permanent;
        rewrite ^/explore/partners/TAMS/browse/(?<original>.*) /$original permanent;
        rewrite ^/en/account/management/(?<original>.*) /$original permanent;
        rewrite ^/embed/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.petco.com/images/colors/color1/(?<original>.*) /$original permanent;
        rewrite ^/reviews/Wellbutrin_vs_Generic_Bupropion/Wellbutrin/(?<original>.*) /$original permanent;
        rewrite ^/review/reviews/(?<original>.*) /reviews/$original permanent;
        rewrite ^/review/(?<original>.*) /reviews/$original permanent;
        rewrite ^/reviewsfood-testing/.*/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.instagram.com/android-app.*/(?<original>.*) /$original permanent;
        rewrite ^/client_error/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/support.google.com/\+/(?<original>.*) /$original permanent;
        rewrite ^/article./.*/(?<original>.*) /$original permanent;
        rewrite ^/WebGraphics/(?<original>.*) /$original permanent;
        rewrite ^/subscribe-more/(?<original>.*) /$original permanent;
        rewrite ^/pt/home/(?<original>.*) /$original permanent;
        rewrite ^/soundcloud-tpa/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www3.bostonglobe.com/.*/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/www.allinea.com/.*/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/highqualityevidence.blogspot.com/.*/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/newcriterion.com/.*\.com/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/support.google.com/gm/(?<original>.*) /$original permanent;
        rewrite ^/subscribe/(?<original>.*) /$original permanent;
        rewrite ^/story/[0-9]+/(?<original>.*) /$original permanent;
        rewrite ^/static/bundles/(?<original>.*) /$original permanent;
        rewrite ^/pages/feedback/(?<original>.*) /$original permanent;
        rewrite ^/onward/notify/(?<original>.*) /$original permanent;
        rewrite ^/members/exclusives/(?<original>.*) /$original permanent;
        rewrite ^/embedded-video/(?<original>.*) /$original permanent;
        rewrite ^/elections/chatbot/(?<original>.*) /$original permanent;
        rewrite ^/iq-tests/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/external/languages-dist/smart/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/researchnews.osu.edu/player.vimeo.com/video/(?<original>.*) /$original permanent;
        rewrite ^/docs/www/support.google.com/Edg/(?<original>.*) /$original permanent;
        rewrite ^/outdoor-adventure/exploration/the-king-of-the-ferret-leggers/(?<original>.*) /$original permanent;
        rewrite ^/food-testing/laboratories/eurofins-food-integrity-and-innovation/(?<original>.*) /$original permanent;
        rewrite ^/.*/Trident/(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*)\$$ /$original permanent;
        rewrite ^/(?<original>.*)\)$ /$original permanent;
        rewrite ^/(?<original>.*)\)\)$ /$original permanent;
        rewrite ^/(?<original>.*)\($ /$original permanent;
        rewrite ^/(?<original>.*)\.$ /$original permanent;
        rewrite ^/(?<original>.*),$ /$original permanent;
        rewrite ^/(?<original>.*)_$ /$original permanent;
        rewrite ^/(?<original>.*)-$ /$original permanent;
        rewrite ^/(?<original>.*)\;$ /$original permanent;
        rewrite ^/(?<original>.*)\+$ /$original permanent;
        rewrite ^/article/.*(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*)\%26amp\;quot\; /$original permanent;
        rewrite ^/\%26amp\;quot\;(?<original>.*) /$original permanent;
        rewrite ^/.*\%26amp\;quot\;(?<original>.*) /$original permanent;
        rewrite ^/newsletter/2020/%26amp\;quot\;https\:\/\/.*/(?<original>.*) /$original permanent;
        ## rewrite mistaken newsletter URLs like '/newsletter/2019/7' to '/newsletter/2019/07':
        rewrite ^/newsletter/(?<originalYear>20[0-5][0-9])/(?<originalMonth>[0-9])$ /newsletter/$originalYear/0$originalMonth permanent;
        rewrite ^/.*/%c3%a2%c2%80%c2%98.*/(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*)-ORDER-BY-.*/ /$original permanent;
        rewrite ^/newsletter/2[0-9][0-9][0-9]/docs/www/(?<original>.*) /docs/www/$original permanent;
        rewrite ^/[a-zA-Z].*/static/js/(?<original>.*\.js)$ /static/js/$original permanent;
        rewrite ^/.*\|\.\/\/(?<original>.*) /$original permanent;
        rewrite ^/\%26amp\;quot\;.*/(?<original>.*) /$original permanent;
        rewrite ^/\%26amp\;.*quot\;.*/(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*)\&quot$ /$original permanent;
        rewrite ^/(?<original>.*)\&[a-z][a-z]=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\?[0-9]$ /$original permanent;
        rewrite ^/(?<original>.*)\.pag$ /$original.page permanent;
        rewrite ^/\.\/docs/(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*)\=$ /$original permanent;
        # rewrite ^/(?<original>.*)\%[0-9]C.*$ /$original permanent;
        # rewrite ^/(?<original>.*)\%[0-9]D.*$ /$original permanent;
        # rewrite ^/(?<original>.*)\%[0-9]F.*$ /$original permanent;
        # rewrite ^/(?<original>.*)\%5D$ /$original permanent;
        rewrite ^/(?<original>.*)\%5C.*$ /$original permanent;
        rewrite ^/(?<original>.*)%5C.*$ /$original permanent;
        rewrite ^/(?<original>.*)\|$ /$original permanent;
        rewrite ^/\/(?<original>.*)$ /$original permanent;
        rewrite ^/\/\/(?<original>.*)$ /$original permanent;
        rewrite ^/\/\/\/(?<original>.*)$ /$original permanent;
        rewrite ^/.*-https:\/\/www.gwern.net/(?<original>.*)$ /$original permanent;
        rewrite ^/blob/master/(?<original>.*)$ /$original permanent;
        rewrite ^/docs/.*/(?<original>docs/www/.*)$ /$original permanent;
        rewrite ^/does/(?<original>.*)$ /docs/$original permanent;
        rewrite ^/(?<original>docs/.*/[12].*\.pd)$ /$original\f permanent;
        rewrite ^/tag/.*/(?<original>.*)$ /tags/$original permanent;
        rewrite ^/(?<original1>.*)­(?<original2>.*)$ /$original1-$original2 permanent;
        rewrite ^/(?<original1>docs/.*)--(?<original2>.*pdf)$ /$original1-$original2 permanent; # wandb.ai likes double-dashes?
        rewrite ^/(?<original1>.*)—(?<original2>.*)$ /$original1-$original2 permanent;
        rewrite ^/docs/rotten.com/library/bio/crime/killer-moms/darlie-routier/(?<original>.*) /docs/rotten.com/library/bio/crime/criminals/darlie-routier/$original permanent;
        rewrite ^/docs/rotten.com/library/bio/authors/Richard_Scarry/(?<original>.*) /docs/rotten.com/library/bio/authors/richard-scarry/$original permanent;
        rewrite ^/docs/rotten.com/library/bio/crime/serial-killers/Fred_and_Rosemary_West/(?<original>.*) /docs/rotten.com/library/bio/crime/serial-killers/wests/$original permanent;
        rewrite ^/dos/(?<original>.*) /docs/$original permanent;
        rewrite ^/GPT-2-Folk-Music-\%C2\%B7-Gwern\.net_files/(?<original>.*) /docs/ai/music/$original permanent;
        rewrite ^/(?<original1>.*)/%E2%80%8B(?<original2>.*)$ /$original1/$original2 permanent;
        rewrite ^/(?<original1>.*)%E2%80%8B(?<original2>.*)$ /$original1$original2 permanent;
        rewrite ^/(?<original>.*)jpg\?fill\=solid$ /$original permanent;
        rewrite ^/index/(?<original>.*)$ /$original permanent;
        rewrite ^/(?<original>.*)\~$ /$original permanent;
        rewrite ^/(?<original>.*)\:$ /$original permanent;
        rewrite ^/(?<original>.*),page$ /$original.page permanent;
        rewrite ^/(?<original>.*)\.md$ /$original.page permanent;
        rewrite ^/(?<original>.*)\.markdown$ /$original.page permanent;
        rewrite ^/(?<original>.*)\.source$ /$original.page permanent;
        rewrite ^/(?<original>.*)\<br\>$ $original.page permanent;
        rewrite ^/-(?<original>.*)$ /$original permanent;
        rewrite ^/(?<original>.*)\.tmp$ /$original permanent;
        rewrite ^/(?<original>.*)\.pd\/f$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)https:\/\/www\.gwern\.net\/.*$ /$original permanent;
        rewrite ^/(?<original>.*)\?fbclid\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)&imgrefurl.*$ /$original permanent;
        rewrite ^/(?<original>.*)\]$ /$original permanent;
        rewrite ^/(?<original>.*)\<.*$ /$original permanent;
        rewrite ^/(?<original>.*)\>.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*/)[0-9][0-9][0-9][0-9]$ /$original permanent;
        rewrite ^/(?<original>docs/.*/)[0-9][0-9][0-9][0-9]-$ /$original permanent;
        rewrite ^/docs/www.rotten.com/(?<original>.*)$ /docs/rotten.com/$original permanent;
        rewrite ^/(?<original>docs/.*)\.pd$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\.p$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\/pdf.*$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\.pd$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\.p$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\.\.\.$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)…$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*\.pdf)…$ /$original permanent;
        rewrite ^/(?<original>.*)\*\*$ /$original permanent;
        rewrite ^/(?<original>.*)\*$ /$original permanent;
        rewrite ^/(?<original>.*)\&lang=en$ /$original permanent;
        rewrite ^/(?<original>.*)\&sa=.*$ /$original permanent;
        rewrite ^/docs/eva/docs/eva/(?<original>.*)$ /docs/eva/$original permanent;
        rewrite ^/(?<original>.*)\?utm_.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&lang=en$ /$original permanent;
        rewrite ^/(?<original>.*)\?revision=.*$ /$original permanent;
        rewrite ^/images%25252F(?<original>.*)$ /images/$original permanent;
        rewrite ^/images%25252Fthumbnails%25252Fwikipedia%25252F(?<original>.*)$ /images/thumbnails/wikipedia/$original permanent;
        rewrite ^/(?<original>.*)\?amp\;\?amp\;.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*\.pdf)The$ /$original permanent;
        rewrite ^/(?<original>.*)\&spec\=ft100x75$ /$original permanent;
        rewrite ^/(?<original>.*)\'A\=0$ /$original permanent;
        rewrite ^/(?<original>.*)\?usg=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&usg=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&$ /$original permanent;
        rewrite ^/(?<original>.*)\+\&cd\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&ved\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&xid\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&fbid.*$ /$original permanent;
        rewrite ^/(?<original>.*)\?fbid.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&fbclid.*$ /$original permanent;
        rewrite ^/(?<original>.*)\?fbclid.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&key=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&id\=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\%E2\%80\%99$ /$original permanent;
        rewrite ^/(?<original>.*)\%60$ /$original permanent;
        rewrite ^/(?<original>.*)// /$original/ permanent;
        # match surprising pervasive errors of appending an entire URL, like '/docs/culture/2012-russell.pdfhttps://www.google.com/amp/s/www.oprahmag.com/life/health/amp27336010/rewatching-old-reruns-is-good-for-your-health-study/index.html'
        rewrite ^/(?<original>docs/.*\.pdf)http.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*\.html)http.*$ /$original permanent;
        rewrite ^/doc/(?<original>.*)$ /docs/$original permanent;
        rewrite ^/(?<original>.*\.pdf)\.pdf$ /$original permanent;
        rewrite ^/(?<original>.*)/index\.html\?KEY1\[KEY2\]\=VALUE0$ /$original permanent;
        rewrite ^/(?<original>.*)http$ /$original permanent;
        rewrite ^/(?<original>.*)https$ /$original permanent;
        rewrite ^/(?<original>.*)_$ /$original permanent;
        rewrite ^/(?<original>.*)__$ /$original permanent;
        rewrite ^/static/js/(?<original>.*)\.js\.map$ /static/js/$original permanent;
        rewrite ^/docs/(?<original>.*\.pdf)/index.*$ /docs/$original permanent;
        rewrite ^/docs/(?<original>.*\.pdf)/$ /docs/$original permanent;
        rewrite ^/(?<original>.*)\&hl\=en$ /$original permanent;
        rewrite ^/[A-Z].*(?<original>/tags/.*) /$original permanent;
        rewrite ^/(?<original>docs/.*/index)/index.html /$original permanent;
        rewrite ^/newsletter/(?<original>2[0-9][0-9][0-9]/[01][0-9])/index.html /newsletter/$original permanent;
        rewrite ^/(?<original>.*)\&lt$ /$original permanent;
        rewrite ^/(?<original>.*)\&gt$ /$original permanent;
        rewrite ^/en/about/cookies/(?<original>.*) /$original permanent;
        rewrite ^/en/activities/(?<original>.*) /$original permanent;
        rewrite ^/en/datasets/(?<original>.*) /$original permanent;
        rewrite ^/en/clippings/(?<original>.*) /$original permanent;
        rewrite ^/en/organisations/(?<original>.*) /$original permanent;
        rewrite ^/en/persons/(?<original>.*) /$original permanent;
        rewrite ^/en/prizes/(?<original>.*) /$original permanent;
        rewrite ^/en/publications/(?<original>.*) /$original permanent;
        rewrite ^/en/(?<original>.*) /$original permanent;
        rewrite ^/img/(?<original>.*) /static/img/$original permanent;
        rewrite ^/(?<original>.*)Cache /$original permanent;
        rewrite ^/dics/(?<original>.*) /docs/$original permanent;
        rewrite ^/docs/catnip/(?<original>.*) /docs/cat/$original permanent;
        rewrite ^/docs/sr/pickard/(?<original>.*) /docs/darknet-markets/william-pickard/$original permanent;
        rewrite ^/docs/lwsurvey/hpmor/(?<original>.*) /docs/lesswrong-survey/hpmor/$original permanent;
        rewrite ^/docs/rl/armstrong-controlproblem/ /docs/reinforcement-learning/armstrong-controlproblem/$original permanent;
        rewrite ^/(?<original>docs/.*)/index/index.html /$original/index permanent;
        rewrite ^/(?<original>docs/.*)\.pd/f.$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)\.pd\\f.*$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*)-pdf$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)https://www.gwern.net.*$ /$original permanent; # eg. '/CO2-Coinhttps://www.gwern.net/CO2-Coin'
        rewrite ^/(?<original>docs/.*)/index/$ /$original/index permanent;
        rewrite ^/(?<original>.*)\{$ /$original permanent;
        rewrite ^/(?<original>.*)\}$ /$original permanent;
        rewrite ^/(?<original>.*)\.$ /$original permanent;
        rewrite ^/(?<original>.*)\;$ /$original permanent;
        rewrite ^/(?<original>.*)\,$ /$original permanent;
        rewrite ^/(?<original>.*)\"$ /$original permanent;
        rewrite ^/(?<original>.*)\'$ /$original permanent;
        rewrite ^/Docs/(?<original>.*)$ /docs/$original permanent;
        rewrite ^/(?<original>.*)\.Pdf$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)\.PDf$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)\.PDF$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)\.pDF$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)\.pdF$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)undefined$ /$original permanent;

        # deal en masse with spam hits from local Reddit archives
        rewrite ^/DotA2/(?<original>.*)$ https://old.reddit.com/r/DotA2/$original permanent;
        rewrite ^/place/(?<original>.*)$ https://old.reddit.com/r/place/$original permanent;
        rewrite ^/AIDungeon/(?<original>.*)$ https://old.reddit.com/r/AIDungeon/$original permanent;
        rewrite ^/AnimalsBeingDerps/(?<original>.*)$ https://old.reddit.com/r/AnimalsBeingDerps/$original permanent;
        rewrite ^/Bitcoin/(?<original>.*)$ https://old.reddit.com/r/Bitcoin/$original permanent;
        rewrite ^/CucumbersScaringCats/(?<original>.*)$ https://old.reddit.com/r/CucumbersScaringCats/$original permanent;
        rewrite ^/DIY_eJuice/(?<original>.*)$ https://old.reddit.com/r/DIY_eJuice/$original permanent;
        rewrite ^/DecisionTheory/(?<original>.*)$ https://old.reddit.com/r/DecisionTheory/$original permanent;
        rewrite ^/Futurology/(?<original>.*)$ https://old.reddit.com/r/Futurology/$original permanent;
        rewrite ^/GPT3/(?<original>.*)$ https://old.reddit.com/r/GPT3/$original permanent;
        rewrite ^/HPMOR/(?<original>.*)$ https://old.reddit.com/r/HPMOR/$original permanent;
        rewrite ^/HobbyDrama/(?<original>.*)$ https://old.reddit.com/r/HobbyDrama/$original permanent;
        rewrite ^/IAmA/(?<original>.*)$ https://old.reddit.com/r/IAmA/$original permanent;
        rewrite ^/IncreasinglyVerbose/(?<original>.*)$ https://old.reddit.com/r/IncreasinglyVerbose/$original permanent;
        rewrite ^/LSD/(?<original>.*)$ https://old.reddit.com/r/LSD/$original permanent;
        rewrite ^/LessWrong/(?<original>.*)$ https://old.reddit.com/r/LessWrong/$original permanent;
        rewrite ^/MEMarketplace/(?<original>.*)$ https://old.reddit.com/r/MEMarketplace/$original permanent;
        rewrite ^/MLPtunes/(?<original>.*)$ https://old.reddit.com/r/MLPtunes/$original permanent;
        rewrite ^/MachineLearning/(?<original>.*)$ https://old.reddit.com/r/MachineLearning/$original permanent;
        rewrite ^/MapPorn/(?<original>.*)$ https://old.reddit.com/r/MapPorn/$original permanent;
        rewrite ^/MediaSynthesis/(?<original>.*)$ https://old.reddit.com/r/MediaSynthesis/$original permanent;
        rewrite ^/NavySealCopypasta/(?<original>.*)$ https://old.reddit.com/r/NavySealCopypasta/$original permanent;
        rewrite ^/Parahumans/(?<original>.*)$ https://old.reddit.com/r/Parahumans/$original permanent;
        rewrite ^/Perfectfit/(?<original>.*)$ https://old.reddit.com/r/Perfectfit/$original permanent;
        rewrite ^/Pets/(?<original>.*)$ https://old.reddit.com/r/Pets/$original permanent;
        rewrite ^/Piracy/(?<original>.*)$ https://old.reddit.com/r/Piracy/$original permanent;
        rewrite ^/PrequelMemes/(?<original>.*)$ https://old.reddit.com/r/PrequelMemes/$original permanent;
        rewrite ^/Psychonaut/(?<original>.*)$ https://old.reddit.com/r/Psychonaut/$original permanent;
        rewrite ^/QuantifiedSelf/(?<original>.*)$ https://old.reddit.com/r/QuantifiedSelf/$original permanent;
        rewrite ^/QuantikXanax/(?<original>.*)$ https://old.reddit.com/r/QuantikXanax/$original permanent;
        rewrite ^/Re_Zero/(?<original>.*)$ https://old.reddit.com/r/Re_Zero/$original permanent;
        rewrite ^/SDAM/(?<original>.*)$ https://old.reddit.com/r/SDAM/$original permanent;
        rewrite ^/SampleSize/(?<original>.*)$ https://old.reddit.com/r/SampleSize/$original permanent;
        rewrite ^/Scholar/(?<original>.*)$ https://old.reddit.com/r/Scholar/$original permanent;
        rewrite ^/Scotland/(?<original>.*)$ https://old.reddit.com/r/Scotland/$original permanent;
        rewrite ^/SheepMarketplace/(?<original>.*)$ https://old.reddit.com/r/SheepMarketplace/$original permanent;
        rewrite ^/SilkRoad/(?<original>.*)$ https://old.reddit.com/r/SilkRoad/$original permanent;
        rewrite ^/SpiceandWolf/(?<original>.*)$ https://old.reddit.com/r/SpiceandWolf/$original permanent;
        rewrite ^/StartledCats/(?<original>.*)$ https://old.reddit.com/r/StartledCats/$original permanent;
        rewrite ^/SubSimulatorGPT2/(?<original>.*)$ https://old.reddit.com/r/SubSimulatorGPT2/$original permanent;
        rewrite ^/SubSimulatorGPT2Meta/(?<original>.*)$ https://old.reddit.com/r/SubSimulatorGPT2Meta/$original permanent;
        rewrite ^/Supplements/(?<original>.*)$ https://old.reddit.com/r/Supplements/$original permanent;
        rewrite ^/TOR/(?<original>.*)$ https://old.reddit.com/r/TOR/$original permanent;
        rewrite ^/TOUHOUMUSIC/(?<original>.*)$ https://old.reddit.com/r/TOUHOUMUSIC/$original permanent;
        rewrite ^/TheMotte/(?<original>.*)$ https://old.reddit.com/r/TheMotte/$original permanent;
        rewrite ^/TomMarketplace/(?<original>.*)$ https://old.reddit.com/r/TomMarketplace/$original permanent;
        rewrite ^/Tulpas/(?<original>.*)$ https://old.reddit.com/r/Tulpas/$original permanent;
        rewrite ^/UnresolvedMysteries/(?<original>.*)$ https://old.reddit.com/r/UnresolvedMysteries/$original permanent;
        rewrite ^/WTF/(?<original>.*)$ https://old.reddit.com/r/WTF/$original permanent;
        rewrite ^/WeAreTheMusicMakers/(?<original>.*)$ https://old.reddit.com/r/WeAreTheMusicMakers/$original permanent;
        rewrite ^/atlantis/(?<original>.*)$ https://old.reddit.com/r/atlantis/$original permanent;
        rewrite ^/electronic_cigarettes/(?<original>.*)$ https://old.reddit.com/r/electronic_cigaretttes/$original permanent;
        rewrite ^/estimation/(?<original>.*)$ https://old.reddit.com/r/estimation/$original permanent;
        rewrite ^/fitnesscirclejerk/(?<original>.*)$ https://old.reddit.com/r/fitnesscirclejerk/$original permanent;
        rewrite ^/genewolfe/(?<original>.*)$ https://old.reddit.com/r/genewolfe/$original permanent;
        rewrite ^/grams/(?<original>.*)$ https://old.reddit.com/r/grams/$original permanent;
        rewrite ^/hangovereffect/(?<original>.*)$ https://old.reddit.com/r/hangovereffect/$original permanent;
        rewrite ^/haskell_proposals/(?<original>.*)$ https://old.reddit.com/r/haskell_proposals/$original permanent;
        rewrite ^/havanamarket/(?<original>.*)$ https://old.reddit.com/r/havanamarket/$original permanent;
        rewrite ^/holdmycatnip/(?<original>.*)$ https://old.reddit.com/r/holdmycatnip/$original permanent;
        rewrite ^/interestingasfuck/(?<original>.*)$ https://old.reddit.com/r/interestingasfuck/$original permanent;
        rewrite ^/kratom/(?<original>.*)$ https://old.reddit.com/r/kratom/$original permanent;
        rewrite ^/lowlevelaware/(?<original>.*)$ https://old.reddit.com/r/lowlevelaware/$original permanent;
        rewrite ^/math/(?<original>.*)$ https://old.reddit.com/r/math/$original permanent;
        rewrite ^/medsforbitcoin/(?<original>.*)$ https://old.reddit.com/r/medsforbitcoin/$original permanent;
        rewrite ^/microdosing/(?<original>.*)$ https://old.reddit.com/r/microdosing/$original permanent;
        rewrite ^/minimalism/(?<original>.*)$ https://old.reddit.com/r/minimalism/$original permanent;
        rewrite ^/mlscaling/(?<original>.*)$ https://old.reddit.com/r/mlscaling/$original permanent;
        rewrite ^/modup/(?<original>.*)$ https://old.reddit.com/r/modup/$original permanent;
        rewrite ^/mylittlepony/(?<original>.*)$ https://old.reddit.com/r/mylittlepony/$original permanent;
        rewrite ^/neography/(?<original>.*)$ https://old.reddit.com/r/neography/$original permanent;
        rewrite ^/neuro/(?<original>.*)$ https://old.reddit.com/r/neuro/$original permanent;
        rewrite ^/onions/(?<original>.*)$ https://old.reddit.com/r/onions/$original permanent;
        rewrite ^/philosophy/(?<original>.*)$ https://old.reddit.com/r/philosophy/$original permanent;
        rewrite ^/programming/(?<original>.*)$ https://old.reddit.com/r/programming/$original permanent;
        rewrite ^/r/haskell/(?<original>.*)$ https://old.reddit.com/r/haskell/$original permanent;
        rewrite ^/rational/(?<original>.*)$ https://old.reddit.com/r/rational/$original permanent;
        rewrite ^/reinforcementlearning/(?<original>.*)$ https://old.reddit.com/r/reinforcementlearning/$original permanent;
        rewrite ^/researchchemicals/(?<original>.*)$ https://old.reddit.com/r/researchchemicals/$original permanent;
        rewrite ^/sanitariummarket/(?<original>.*)$ https://old.reddit.com/r/sanitariummarket/$original permanent;
        rewrite ^/science/(?<original>.*)$ https://old.reddit.com/r/science/$original permanent;
        rewrite ^/skeptic/(?<original>.*)$ https://old.reddit.com/r/skeptic/$original permanent;
        rewrite ^/slatestarcodex/(?<original>.*)$ https://old.reddit.com/r/slatestarcodex/$original permanent;
        rewrite ^/startups/(?<original>.*)$ https://old.reddit.com/r/startups/$original permanent;
        rewrite ^/statistics/(?<original>.*)$ https://old.reddit.com/r/statistics/$original permanent;
        rewrite ^/techsupport/(?<original>.*)$ https://old.reddit.com/r/techsupport/$original permanent;
        rewrite ^/themarketplace/(?<original>.*)$ https://old.reddit.com/r/themarketplace/$original permanent;
        rewrite ^/touhou/(?<original>.*)$ https://old.reddit.com/r/touhou/$original permanent;
        rewrite ^/transhumanism/(?<original>.*)$ https://old.reddit.com/r/transhumanism/$original permanent;
        rewrite ^/trees/(?<original>.*)$ https://old.reddit.com/r/trees/$original permanent;
        rewrite ^/unsong/(?<original>.*)$ https://old.reddit.com/r/unsong/$original permanent;
        rewrite ^/wholesomeanimememes/(?<original>.*)$ https://old.reddit.com/r/wholesomeanimememes/$original permanent;
        rewrite ^/wholesomeanimemes/(?<original>.*)$ https://old.reddit.com/r/wholesomeanimemes/$original permanent;
        rewrite ^/wikipedia/(?<original>.*)$ https://old.reddit.com/r/wikipedia/$original permanent;

        rewrite ^/(?<original>.*/dp/B.*)$ https://amazon.com/$original permanent; # eg. '/Miracle-Philadelphia-Constitutional-Convention-September/dp/B0007ELQH0'
        rewrite ^/(?<original>docs/www/.*)\.pdf%23(?<anchor>[a-z0-9=]+)$ /$original.pdf\#$anchor permanent;
        rewrite ^/docs/www/(?<original>.*)/\&quot$ https://$original permanent;

        # fix any hits to now-removed external link-bibliographies:
        rewrite ^/(?<original>.*)-link-bibliography /$original permanent;

        # fix older annotations pre-interwiki-canonicalization: [a-z] → [A-Z]: (write out by hand because the recommended nginx way is to shell out to Lua in a separate block, and I don't want to mess with such complexity)
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fa(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FA$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fb(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FB$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fc(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FC$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fd(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FD$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fe(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FE$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Ff(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FF$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fg(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FG$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fh(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FH$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fi(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FI$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fj(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FJ$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fk(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FK$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fl(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FL$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fm(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FM$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fn(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FN$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fo(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FO$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fp(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FP$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fq(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FQ$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fr(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FR$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fs(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FS$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Ft(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FT$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fu(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FU$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fv(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FV$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fw(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FW$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fx(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FX$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fy(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FY$suffix permanent;
        rewrite ^/metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2Fz(?<suffix>.*)$ /metadata/annotations/https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FZ$suffix permanent;

        # post-WP popup shift to fully-dynamic:
        rewrite ^/images/thumbnails/wikipedia/[0-9][0-9][0-9]px-(?<original>.*) https://en.wikipedia.org/wiki/File:$original permanent;
        rewrite ^/images/thumbnails/wikipedia/(?<original>.*) https://en.wikipedia.org/wiki/File:$original permanent;
        rewrite ^/metadata/annotations/https%253A%252F%252Fen.wikipedia.org%252Fwiki%252F(?<original>.*)\.html$ https://en.wikipedia.org/wiki/$original permanent;
        rewrite ^/(?<original>docs/.*).Pdf /$original.pdf permanent;
        rewrite ^/(?<original>.*)\&source=gmail /$original permanent;
        rewrite ^/(?<original>emociones/.*) https://competicionmental.appspot.com/$original permanent;
        rewrite ^/(?<original>sound/[a-z]+\.mp3) https://competicionmental.appspot.com/$original permanent;
        rewrite ^/(?<original>letrasImg/.*.png) https://competicionmental.appspot.com/$original permanent;
        rewrite ^/(?<original>letra/.*) https://competicionmental.appspot.com/$original permanent;
        rewrite ^/(?<original>/figuras/.*.png) https://competicionmental.appspot.com/$original permanent;
        rewrite ^/(?<original>.*)\&rut\=.* /$original permanent;
        rewrite ^/(?<original>.*)\&lang\=.* /$original permanent;
        rewrite ^/(?<original>.*)\&keyword\=.* /$original permanent;
        rewrite ^/(?<original>docs/.*/)\&quot.* /$original/index permanent;
        rewrite ^/backlinks/(?<original>.*) /metadata/annotations/backlinks/$original permanent;
        rewrite ^/(?<original1>.*)\'.*(?<original2>.*)$ /$original1-$original2 permanent; # ' → -
        rewrite ^/(?<original>.*)\?revision=.*$ /$original permanent;
        rewrite ^/(?<original>.*)\&amp\;.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*/.*\.pdf)-.*$ /$original permanent; # deal with all the erroneous PDF links like '/docs/iq/2018-warne.pdf-en-espanol'
        rewrite ^/(?<original>docs/.*/.*\.pdf)[A-Z][a-z]+$ /$original permanent; # '/docs/psychology/writing/1993-ericsson.pdfEriksson'
        rewrite ^/(?<original>.page)/.*$ /$original permanent; # '/foo.page/', surprisingly common
        rewrite ^/(?<original>.*)\&tbnid.*$ /$original permanent;
        rewrite ^/(?<original>.*)\]$ /$original permanent;
        rewrite ^/(?<original>.*)\[$ /$original permanent;
        rewrite ^/\.\/(?<original>.*) /$original permanent;
        rewrite ^/(?<original>.*).PAGE$ /$original.page permanent;
        rewrite ^/(?<original>.*)\’ /$original permanent;
        rewrite ^/(?<original>.*)\&title.*$ /$original permanent;
        rewrite ^/(?<original>.*).pagee$ /$original.page permanent;
        rewrite ^/(?<original>.*/)url$ /$original permanent;
        rewrite ^/(?<original>docs/.*\.pdf)/.*$ /$original permanent;
        rewrite ^/(?<original>tags/.*).page.*$ /$original permanent;
        rewrite ^/(?<original>.*).pages$ /$original.page permanent;
        rewrite ^/(?<original>.*).Page$ /$original.page permanent;
        rewrite ^/(?<original>.*)adminer\..*$ /$original permanent;
        rewrite ^/(?<original>docs/.*\.pd)\/(?<ext>f).*$ /$original$ext permanent;
        rewrite ^/(?<original>docs/.*\.pd)%5c(?<ext>f).*$ /$original$ext permanent;
        rewrite ^/(?<original>docs/.*\.)-pdf$ /$original.pdf permanent;
        rewrite ^/(?<original>docs/.*\.pdf)y$ /$original permanent;
        rewrite ^/(?<original>docs/.*\.pdf)y$ /$original permanent;
        rewrite ^/(?<original>.*)；.*$ /$original permanent;
        rewrite ^/(?<original>pubmed/.*)$ https://www.ncbi.nlm.nih.gov/$original permanent;
        rewrite ^/(?<original>pmc/articles/.*)$ https://www.ncbi.nlm.nih.gov/$original permanent;
        rewrite ^/(?<original>.*)”$ /$original permanent;
        rewrite ^/(?<original>.*\.html)[0-9]+$ /$original permanent;
        rewrite ^/(?<original>.*/index)/index.html /$original permanent;
        rewrite ^/docs/pyschology/(?<original>.*)$ /docs/psychology/$original permanent;
        rewrite ^/(?<original>static/font/.*.ttf).*-format.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*)/inde$ /$original/index permanent;
        rewrite ^/(?<original>.*[a-z])(?<originalAnchor>fn[0-9]+)$    /$original\#$originalAnchor permanent;
        rewrite ^/(?<original>.*[a-z])(?<originalAnchor>fnref[0-9]+)$ /$original\#$originalAnchor permanent;
        rewrite ^/(?<original>.*[a-z])(?<originalAnchor>sn[0-9]+)$    /$original\#$originalAnchor permanent;
        rewrite ^/(?<original>.*)/[0-9]+px-.*em.*$ /$original permanent;
        rewrite ^/images/(?<original>201[2-5]-[01][1-9]-[1-3][0-9]-tumblr_[mn][a-z0-9_]+_640\.png).*$ /images/hardtruthsfromsoftcats.tumblr.com/$original;
        rewrite ^/(?<original>docs/.*)\]\(http.*$ /$original permanent;
        rewrite ^/metadata/annotations/similar/(?<original>.*)$ /metadata/annotations/similars/$original permanent;
        rewrite ^/docs/psycology/(?<original>.*)$ /docs/psychology/$original permanent;
        rewrite ^/docs/www/pkhungurn\.github\.io/data/videos/(?<original>.*)$ https://pkhungurn.github.io/data/videos/$original permanent;
        rewrite ^(?<original>.*)\?.*callback=.*from=.*$ /$original permanent;
        rewrite ^(?<original>.*)\?service=.*$ /$original permanent;
        rewrite ^(?<original>.*)\?relatedposts_hit=.*$ /$original permanent;
        rewrite ^/(?<original>docs/.*),pdf$ /$original.pdf permanent;
        rewrite ^/(?<original>.*)%C3%A7$ /$original permanent;
        rewrite ^/(?<original>.*)/index/index$ /$original/index permanent;
        rewrite ^/ttps://www\.gwern\.net/(?<original>.*)$ /$original permanent;

        rewrite ^/docs/silk-road/(?<old>.*)$ /docs/darknet-markets/$old permanent;
        rewrite ^/docs/ai/stylegan/(?<old>.*)$ /docs/ai/gan/stylegan/$old permanent;
        rewrite ^/docs/ai/rnn/(?<old>.*)$ /docs/ai/nn/rnn/$old permanent;
        rewrite ^/docs/ai/fully-connected/(?<old>.*)$ /docs/ai/nn/fully-connected/$old permanent;
        rewrite ^/docs/ai/gpt/(?<old>.*)$ /docs/ai/nn/transformer/gpt/$old permanent;
        rewrite ^/docs/ai/gan/(?<old>.*)$ /docs/ai/nn/gan/$old permanent;
        rewrite ^/docs/reinforcement-learning/alphago/(?<old>.*)$ /docs/reinforcement-learning/model/alphago/$old permanent;
        rewrite ^/docs/reinforcement-learning/muzero/(?<old>.*)$ /docs/reinforcement-learning/model/muzero/$old permanent;
        rewrite ^/docs/reinforcement-learning/oa5/(?<old>.*)$ /docs/reinforcement-learning/model-free/oa5/$old permanent;
        rewrite ^/docs/reinforcement-learning/alphastar/(?<old>.*)$ /docs/reinforcement-learning/model-free/alphastar/$old permanent;
        rewrite ^/docs/eva/(?<old>.*)$ /docs/anime/eva/$old permanent;
        rewrite ^/docs/conscientiousness/(?<old>.*)$ /docs/psychology/personality/conscientiousness/$old permanent;
        rewrite ^/docs/spaced-repetition/(?<old>.*)$ /docs/psychology/spaced-repetition/$old permanent;
        rewrite ^/docs/psychology/bird/(?<old>.*)$ /docs/psychology/animal/bird/$old permanent;
        rewrite ^/docs/prediction/(?<old>.*)$ /docs/statistics/prediction/$old permanent;
        rewrite ^/docs/terrorism/(?<old>.*)$ /docs/crime/terrorism/$old permanent;
        rewrite ^/docs/statistics/crime/terrorism/(?<old>.*)$ /docs/crime/terrorism/$old permanent;
        rewrite ^/docs/genetics/selection/dysgenics/(?<old>.*)$ /docs/genetics/selection/natural/human/dysgenics/$old permanent;
        rewrite ^/docs/genetics/selection/index-selection/(?<old>.*)$ docs/genetics/selection/artificial/index-selection/$old permanent;
        rewrite ^/docs/genetics/selection/apple/(?<old>.*)$ docs/genetics/selection/artificial/apple/$old permanent;
        rewrite ^/docs/genetics/correlation/(?<old>.*)$ docs/genetics/heritable/correlation/$old permanent;
        rewrite ^/docs/linkrot/(?<old>.*)$ docs/cs/linkrot/$old permanent;
        rewrite ^/docs/advertising/(?<old>.*)$ docs/economics/advertising/$old permanent;
        rewrite ^/xf/BL_Images/(?<original>.*)$ https://www.bluelight.org/xf/BL_Images/$original permanent;
        rewrite ^/docs/sf/(?<old>.*)$ /docs/fiction/science-fiction/$old permanent;
        rewrite ^/docs/ai/alphafold/(?<old>.*)$ /docs/ai/nn/transformer/alphafold/$old permanent;
        rewrite ^/docs/lithium/(?<old>.*)$ /docs/psychiatry/lithium/$old permanent;
        rewrite ^/(?<before>.*)/%E2%80%8B(?<after>.*)$ /$before/$after permanent;
        rewrite ^/docs/iq/smpy/(?<old>.*)$ /docs/iq/high/smpy/$old permanent;
        rewrite ^/docs/iq/anne-roe/(?<old>.*)$ /docs/iq/high/anne-roe/$old permanent;
        rewrite ^/docs/iq/fullerton/(?<old>.*)$ /docs/iq/high/fullerton/$old permanent;
        rewrite ^/docs/iq/munich/(?<old>.*)$ /docs/iq/high/munich/$old permanent;
        rewrite ^/docs/longevity/john-bjorksten/(?<old>.*)$ /docs/longevity/johan-bjorksten/$old permanent;
        rewrite ^/docs/ai/clip/samples/(?<old>.*)$ /docs/ai/nn/transformer/clip/samples/$old permanent;
        rewrite ^/docs/ai/clip/(?<old>.*)$ /docs/ai/nn/transformer/clip/$old permanent;
        rewrite ^/docs/ai/sparsity/(?<old>.*)$ /docs/ai/nn/sparsity/$old permanent;
        rewrite ^/docs/ai/retrieval/(?<old>.*)$ /docs/ai/nn/retrieval/$old permanent;
        rewrite ^/docs/ai/adversarial/(?<old>.*)$ /docs/ai/nn/adversarial/$old permanent;
        rewrite ^/docs/ai/diffusion/(?<old>.*)$ /docs/ai/nn/diffusion/$old permanent;
        rewrite ^/images/ai/diffusion/(?<old>.*)$ /images/ai/nn/diffusion/$old permanent;
        rewrite ^/docs/japanese/(?<old>.*)$ /docs/japan/$old permanent;
        rewrite ^/docs/japan/zeami/(?<old>.*)$ /docs/japan/poetry/zeami/$old permanent;
        rewrite ^/docs/music-distraction/(?<old>.*)$ /docs/music/music-distraction/$old permanent;
        rewrite ^/docs/nature/(?<old>.*)$ /docs/psychology/nature/$old permanent;
        rewrite ^/docs/humor/(?<old>.*)$ /docs/fiction/humor/$old permanent;
        rewrite ^/(?<original>docs/.*)/[0-9]$ /$original permanent;
        rewrite ^/(?<original>docs/.*)/[0-9][0-9]$ /$original permanent;
        rewrite ^/(?<original>docs/.*)/[0-9][0-9][0-9]$ /$original permanent;
        rewrite ^/(?<original>docs/.*)/[0-9][0-9][0-9][0-9]$ /$original permanent;
        rewrite ^/(?<first>.*)%E2%80%93(?<second>.*)$ /$first-$second permanent;
        rewrite ^/\.\/(?<all>.*)$ /$all permanent;

        rewrite ^/images/otakutalk/(?<old>.*)$ /images/eva/otaku-talk/$old permanent;
        rewrite ^/images/storyofyourlife/(?<old>.*)$ /images/story-of-your-life/$old permanent;
        rewrite ^/images/notenkimemoirs/blueblazes/(?<old>.*)$ /images/notenki-memoirs/blue-blazes/$old permanent;
        rewrite ^/images/notenkimemoirs/(?<old>.*)$ /images/notenki-memoirs/$old permanent;
        rewrite ^/images/spacedrepetition/(?<old>.*)$ /images/spaced-repetition/$old permanent;
        rewrite ^/images/dnb/(?<old>.*)$ /images/dual-n-back/$old permanent;
        rewrite ^/images/philo/(?<old>.*)$ /images/philosophy/$old permanent;
        rewrite ^/images/ab/(?<old>.*)$ /images/ab-testing/$old permanent;
        rewrite ^/images/coinflip/(?<old>.*)$ /images/coin-flip/$old permanent;
        rewrite ^/images/silkroad/(?<old>.*)$ /images/silk-road/$old permanent;
        rewrite ^/images/littleboy/(?<old>.*)$ /images/eva/little-boy/$old permanent;
        rewrite ^/images/ai/dalle/2/(?<old>.*)$ /images/ai/dall-e/2/$old permanent;
        rewrite ^/images/ai/dalle/1/(?<old>.*)$ /images/ai/dall-e/1/$old permanent;
        rewrite ^/images/ai/dalle/(?<old>.*)$ /images/ai/dall-e/$old permanent;
        rewrite ^/images/orderstatistics/(?<old>.*)$ /images/statistics/order/$old permanent;
        rewrite ^/images/dinosaurcomics/(?<old>.*)$ /images/humor/dinosaur-comics/$old permanent;
        rewrite ^/images/lwsurvey/(?<old>.*)$ /images/lw-survey/$old permanent;
        rewrite ^/images/rl/(?<old>.*)$ /images/reinforcement-learning/$old permanent;
        rewrite ^/static/static/(?<old>.*)$ /static/$old permanent;
        rewrite /docs/(?<first>[a-z0-9-]+)/docs/(?<second>.*)$ /docs/$first/$second permanent;
        rewrite /docs/(?<first>[a-z0-9-]+/[a-z0-9-]+)/docs/(?<second>[a-z0-9-].*)$ /docs/$first/$second permanent;
        rewrite /docs/(?<first>[a-z0-9-]+/[a-z0-9-]+)/docs/.*/docs/(?<second>[a-z0-9-].*)$ /docs/$first/$second permanent; # rewrite repeated-substitution errors like /docs/economics/advertising/docs/economics/advertising/docs/economics/advertising.../2021-freeman.pdf
        rewrite ^/(?<old>.*)%21W$ /$old permanent;
        rewrite ^/(?<old>.*)%3C/p$ /$old permanent;
        rewrite ^/newslettter/(?<old>.*)$ /newsletter/$old permanent;
        rewrite ^/newsleter/(?<old>.*)$ /newsletter/$old permanent;
        rewrite ^/(?<old>.*)`(?<old2>.*)$ /$old$old2 permanent;
        rewrite ^/(?<old>.*)\.page/index\.html$ /$old.page permanent;
        rewrite ^/(?<old>.*)\.page/$ /$old.page permanent;
        rewrite ^/(?<old>.*)/N/A$ /$old permanent;
        # rewrite LW links like `/posts/5yFRd3cjLpm3Nd6Di/argument-screens-off-authority` (17 character ID):
        rewrite ^(?<old>/posts/[A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9][A-Za-z0-9]/[a-z-]+$) https://lesswrong.com$old permanent;

        # work around *Cloudflare* bugs! For some reason, their servers determinedly drop a slash, every time. ???
        # rewrite ^/metadata/annotations/https\:\/(?<original>[0-9a-zA-Z].*) /metadata/annotations/https%3A%2F%2F$original permanent;
        # rewrite ^/metadata/annotations/http\:\/(?<original>[0-9a-zA-Z].*) /metadata/annotations/http%3A%2F%2F$original permanent;
        rewrite ^/metadata/annotations/docs/(?<original>[0-9a-zA-Z].*) /metadata/annotations/%2Fdocs/$original permanent;
        # rewrite ^/metadata/annotations/(?<original>[A-Z].*) /metadata/annotations/%2F$original permanent;
        # rewrite ^/metadata/annotations/(?<original>[0-9a-ce-gi-z].*) /metadata/annotations/%2F$original permanent;

        ## it's very hard to fix broken '#' anchors since it's client-side, the web server isn't support to see it
        ## and I couldn't find any Nginx solution I understood, so we just strip the trailing garbage:
        rewrite ^(?<u>.*)\#(?<v>.*)     $u permanent;

        ## Strip all query-parameters which are meaningless on Gwern.net & only yield 404s
        ## NOTE: '$args' = '?args' in 'foo.com/bar?args'
        set $args '';
     }

     # Enable redirection? TODO: I don't understand why this seems to be necessary in addition to `map`
     if ($new_uri != "" ) {
        rewrite ^(.*)$ $new_uri permanent;
      }
}
